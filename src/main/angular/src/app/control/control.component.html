<!--
  ~ Copyright (C) 2017 Axel MÃ¼ller <axel.mueller@avanux.de>
  ~
  ~ This program is free software; you can redistribute it and/or modify
  ~ it under the terms of the GNU General Public License as published by
  ~ the Free Software Foundation; either version 2 of the License, or
  ~ (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU General Public License for more appliance.
  ~
  ~ You should have received a copy of the GNU General Public License along
  ~ with this program; if not, write to the Free Software Foundation, Inc.,
  ~ 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
  -->

<div class="ui segment" xmlns="http://www.w3.org/1999/html">
  <form class="ui form" #controlForm="ngForm" (ngSubmit)="submitForm()">
    <div *ngIf="appliance.type != APPLIANCE_TYPE_EVCHARGER" class="fields">
      <div class="field">
        <label>{{'ControlComponent.type' | translate}}</label>
        <select class="ui fluid dropdown" name="controlType" [(ngModel)]="control.type"
                (ngModelChange)="typeChanged($event)">
          <option [ngValue]="TYPE_ALWAYS_ON_SWITCH">{{TYPE_ALWAYS_ON_SWITCH | translate}}</option>
          <option [ngValue]="TYPE_SWITCH">{{TYPE_SWITCH | translate}}</option>
          <option [ngValue]="TYPE_MODBUS_SWITCH">{{TYPE_MODBUS_SWITCH | translate}}</option>
          <option [ngValue]="TYPE_HTTP_SWITCH">{{TYPE_HTTP_SWITCH | translate}}</option>
          <option [ngValue]="TYPE_MOCK_SWITCH">{{TYPE_MOCK_SWITCH | translate}}</option>
        </select>
      </div>
      <div class="ui checkbox">
        <input type="checkbox" name="startingCurrentDetection" [(ngModel)]="control.startingCurrentDetection"
               (ngModelChange)="startingCurrentDetectionChanged($event)"
               [disabled]="isStartingCurrentDetectedDisabled()">
        <label>{{'ControlComponent.startingCurrentDetection' | translate}}</label>
      </div>
    </div>

    <div class="ui fields" *ngIf="control.type===TYPE_SWITCH">
      <div class="field">
        <label>{{'ControlComponent.switch_gpio' | translate}}</label>
        <input type="text" name="switch_gpio" [(ngModel)]="control.switch_.gpio"
               required pattern="{{VALIDATOR_PATTERN_INTEGER}}">
        <div *ngIf="errors.switch_gpio" class="ui negative message">{{errors.switch_gpio}}</div>
      </div>
      <div class="ui checkbox">
        <input type="checkbox" name="switch_reverseStates" [(ngModel)]="control.switch_.reverseStates">
        <label>{{'ControlComponent.switch_reverseStates' | translate}}</label>
      </div>
    </div>

    <div class="ui fields" *ngIf="control.type===TYPE_MODBUS_SWITCH">
      <div class="field">
        <label>{{'ControlComponent.modbusSwitch_idref' | translate}}</label>
        <select class="ui fluid dropdown" name="modbusSwitch_modbusTcpId" [(ngModel)]="control.modbusSwitch.idref">
          <option *ngFor="let modbusSettings of settings.modbusSettings" [ngValue]="modbusSettings.modbusTcpId"
                  [selected]="modbusSettings.modbusTcpId==control.modbusSwitch.idref">
            {{modbusSettings.modbusTcpId}}</option>
        </select>
      </div>
      <div class="field">
        <label>{{'ControlComponent.modbusSwitch_slaveAddress' | translate}}</label>
        <input type="text" name="modbusSwitch_slaveAddress" [(ngModel)]="control.modbusSwitch.slaveAddress"
               required pattern="{{VALIDATOR_PATTERN_INTEGER}}">
        <div *ngIf="errors.modbusSwitch_slaveAddress" class="ui negative message">
          {{errors.modbusSwitch_slaveAddress}}</div>
      </div>
      <div class="field">
        <label>{{'ControlComponent.modbusSwitch_registerAddress' | translate}}</label>
        <input type="text" name="modbusSwitch_registerAddress" [(ngModel)]="control.modbusSwitch.registerAddress"
               required pattern="{{VALIDATOR_PATTERN_INTEGER_OR_HEX}}">
        <div *ngIf="errors.modbusSwitch_registerAddress" class="ui negative message">
          {{errors.modbusSwitch_registerAddress}}</div>
      </div>
      <div class="field">
        <label>{{'ControlComponent.modbusSwitch_registerType' | translate}}</label>
        <select class="ui fluid dropdown" name="registerType" [(ngModel)]="control.modbusSwitch.registerType">
          <option *ngFor="let modbusWriteRegisterType of settingsDefaults.modbusWriteRegisterTypes"
                  [ngValue]="modbusWriteRegisterType"
                  [selected]="modbusWriteRegisterType==control.modbusSwitch.registerType"
          >{{modbusWriteRegisterType}}</option>
        </select>
      </div>
      <div class="field">
        <label>{{'ControlComponent.modbusSwitch_onValue' | translate}}</label>
        <input type="text" name="modbusSwitch_onValue" [(ngModel)]="control.modbusSwitch.onValue"
               required>
        <div *ngIf="errors.modbusSwitch_onValue" class="ui negative message">
          {{errors.modbusSwitch_onValue}}</div>
      </div>
      <div class="field">
        <label>{{'ControlComponent.modbusSwitch_offValue' | translate}}</label>
        <input type="text" name="modbusSwitch_offValue" [(ngModel)]="control.modbusSwitch.offValue"
               required>
        <div *ngIf="errors.modbusSwitch_offValue" class="ui negative message">
          {{errors.modbusSwitch_offValue}}</div>
      </div>
    </div>

    <div *ngIf="control.type===TYPE_HTTP_SWITCH">
      <div class="field">
        <label>{{'ControlComponent.httpSwitch_onUrl' | translate}}</label>
        <input type="text" name="httpSwitch_onUrl" [(ngModel)]="control.httpSwitch.onUrl"
               required pattern="{{VALIDATOR_PATTERN_URL}}">
        <div *ngIf="errors.httpSwitch_onUrl" class="ui negative message">{{errors.httpSwitch_onUrl}}</div>
      </div>
      <div class="field">
        <label>{{'ControlComponent.httpSwitch_onData' | translate}}</label>
        <input type="text" name="httpSwitch_onData" [(ngModel)]="control.httpSwitch.onData">
      </div>
      <div class="field">
        <label>{{'ControlComponent.httpSwitch_offUrl' | translate}}</label>
        <input type="text" name="httpSwitch_offUrl" [(ngModel)]="control.httpSwitch.offUrl"
               required pattern="{{VALIDATOR_PATTERN_URL}}">
        <div *ngIf="errors.httpSwitch_offUrl" class="ui negative message">{{errors.httpSwitch_offUrl}}</div>
      </div>
      <div class="field">
        <label>{{'ControlComponent.httpSwitch_offData' | translate}}</label>
        <input type="text" name="httpSwitch_offData" [(ngModel)]="control.httpSwitch.offData">
      </div>
      <div class="ui fields">
        <div class="field">
          <label>{{'ControlComponent.httpSwitch_username' | translate}}</label>
          <input type="text" name="httpSwitch_username" [(ngModel)]="control.httpSwitch.username">
        </div>
        <div class="field">
          <label>{{'ControlComponent.httpSwitch_password' | translate}}</label>
          <input type="text" name="httpSwitch_password" [(ngModel)]="control.httpSwitch.password">
        </div>
        <div class="field">
          <label>{{'ControlComponent.httpSwitch_contentType' | translate}}</label>
          <input type="text" name="httpSwitch_contentType" [(ngModel)]="control.httpSwitch.contentType">
        </div>
      </div>
    </div>

    <div *ngIf="control.startingCurrentDetection">
      <h4 class="ui dividing header">{{'ControlComponent.startingCurrent' | translate}}</h4>
      <div class="ui fields">
        <div class="field">
          <label>{{'ControlComponent.startingCurrentSwitch_powerThreshold' | translate}}</label>
          <input type="text" name="startingCurrentSwitch_powerThreshold"
                 placeholder="{{controlDefaults.startingCurrentSwitchDefaults_powerThreshold}}"
                 [(ngModel)]="control.startingCurrentSwitch.powerThreshold">
        </div>
        <div class="field">
          <label>
            {{'ControlComponent.startingCurrentSwitch_startingCurrentDetectionDuration' | translate}}</label>
          <input type="text" name="startingCurrentSwitch_startingCurrentDetectionDuration"
                 placeholder="{{controlDefaults.startingCurrentSwitchDefaults_startingCurrentDetectionDuration}}"
                 [(ngModel)]="control.startingCurrentSwitch.startingCurrentDetectionDuration">
        </div>
        <div class="field">
          <label>
            {{'ControlComponent.startingCurrentSwitch_finishedCurrentDetectionDuration' | translate}}</label>
          <input type="text" name="startingCurrentSwitch_finishedCurrentDetectionDuration"
                 placeholder="{{controlDefaults.startingCurrentSwitchDefaults_finishedCurrentDetectionDuration}}"
                 [(ngModel)]="control.startingCurrentSwitch.finishedCurrentDetectionDuration">
        </div>
        <div class="field">
          <label>{{'ControlComponent.startingCurrentSwitch_minRunningTime' | translate}}</label>
          <input type="text" name="startingCurrentSwitch_minRunningTime"
                 placeholder="{{controlDefaults.startingCurrentSwitchDefaults_minRunningTime}}"
                 [(ngModel)]="control.startingCurrentSwitch.minRunningTime">
        </div>
      </div>
    </div>

    <div *ngIf="appliance.type === APPLIANCE_TYPE_EVCHARGER">
      <div class="ui fields">
        <div class="field">
          <label>{{'ControlComponent.evcharger_voltage' | translate}}</label>
          <input type="text" name="evCharger_voltage"
                 [(ngModel)]="control.evCharger.voltage">
        </div>
        <div class="field">
          <label>{{'ControlComponent.evcharger_phases' | translate}}</label>
          <input type="text" name="evCharger_phases"
                 [(ngModel)]="control.evCharger.phases">
        </div>
        <div class="field">
          <label>{{'ControlComponent.evcharger_pollInterval' | translate}}</label>
          <input type="text" name="evCharger_pollInterval"
                 [(ngModel)]="control.evCharger.pollInterval">
        </div>
      </div>
      <div class="ui fields">
        <div class="field">
          <label>{{'ControlComponent.evchargerModbus_idref' | translate}}</label>
          <select class="ui fluid dropdown" name="evChargerModbus_idref" [(ngModel)]="control.evCharger.control.idref">
            <option *ngFor="let modbusSettings of settings.modbusSettings" [ngValue]="modbusSettings.modbusTcpId"
                    [selected]="modbusSettings.modbusTcpId==control.evCharger.control.idref">
              {{modbusSettings.modbusTcpId}}</option>
          </select>
        </div>
        <div class="field">
          <label>{{'ControlComponent.evchargerModbus_slaveAddress' | translate}}</label>
          <input type="text" name="evChargerModbus_slaveAddress"
                 [(ngModel)]="control.evCharger.control.slaveAddress" required pattern="{{VALIDATOR_PATTERN_INTEGER}}">
          <div *ngIf="errors.evChargerModbus_slaveAddress" class="ui negative message">
            {{errors.evChargerModbus_slaveAddress}}</div>
        </div>
      </div>
      <div *ngFor="let modbusConfiguration of control.evCharger.control.configuration; index as i; last as l">
        <div class="ui fields">
          <div class="field">
            <label>{{'ControlComponent.evchargerModbus_name' | translate}}</label>
            <select class="ui fluid dropdown" name="evCharger_name{{i}}"
                    [(ngModel)]="modbusConfiguration.name">
              <option *ngFor="let modbusRegisterName of getModbusRegisterNames()"
                      [ngValue]="modbusRegisterName"
              >{{getTranslatedModbusRegisterName(modbusRegisterName)}}</option>
            </select>
          </div>
          <div class="field">
            <label>{{'ControlComponent.evchargerModbus_registerAddress' | translate}}</label>
            <input type="text" name="evCharger_registerAddress{{i}}"
                   [(ngModel)]="modbusConfiguration.address"
                   required pattern="{{VALIDATOR_PATTERN_INTEGER_OR_HEX}}">
            <div *ngIf="errors.evCharger_registerAddress" class="ui negative message">
              {{errors.evCharger_registerAddress}}</div>
          </div>
          <div class="field">
            <label>{{'ControlComponent.evchargerModbus_write' | translate}}</label>
            <input class="ui checkbox" type="checkbox" name="evCharger_write{{i}}"
                   [(ngModel)]="modbusConfiguration.write">
          </div>
          <div class="field">
            <label>{{'ControlComponent.evchargerModbus_registerType' | translate}}</label>
            <select class="ui fluid dropdown" name="registerType{{i}}"
                    [(ngModel)]="modbusConfiguration.type">
              <option *ngFor="let modbusRegisterType of getModbusRegisterTypes(modbusConfiguration.write)"
                      [ngValue]="modbusRegisterType"
                      [selected]="modbusRegisterType==modbusConfiguration.type"
              >{{modbusRegisterType}}</option>
            </select>
          </div>
          <div class="field" *ngIf="!modbusConfiguration.write">
            <label>{{'ControlComponent.evchargerModbus_bytes' | translate}}</label>
            <input type="text" name="evCharger_bytes{{i}}"
                   [(ngModel)]="modbusConfiguration.bytes">
          </div>
          <div class="field" *ngIf="!modbusConfiguration.write">
            <label>{{'ControlComponent.evchargerModbus_extractionRegex' | translate}}</label>
            <input type="text" name="evCharger_extractionRegex{{i}}"
                   [(ngModel)]="modbusConfiguration.extractionRegex">
          </div>
          <div class="field" *ngIf="modbusConfiguration.write">
            <label>{{'ControlComponent.evchargerModbus_value' | translate}}</label>
            <input type="text" name="evCharger_value{{i}}"
                   [(ngModel)]="modbusConfiguration.value">
          </div>
          <div class="field" style="padding-top: 2.0em">
            <i (click)="removeModbusConfiguration(i)" class="icon big red remove circle"></i>
            <i *ngIf="l" (click)="addModbusConfiguration()" class="icon big green add circle"></i>
          </div>
        </div>
      </div>
    </div>



    <button type="submit" class="ui button" [disabled]="controlForm.pristine||controlForm.invalid">
      {{'button.save' | translate}}</button>
  </form>
  <!--
  <pre>{{control | json}}</pre>
  <pre>{{controlForm.value | json}}</pre>
  -->
</div>
